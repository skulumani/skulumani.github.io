---
layout: post
title: "Starting with GPG and YubiKey"
date: 2019-01-19
tags: [gpg,]
excerpt: "A short introduction to public-key cryptography and GPG."
---

## What is public-key cryptography?

[There](https://github.com/bfrg/gpg-guide) are [many](https://www.gnupg.org/gph/en/manual.html) [guides](https://en.wikibooks.org/wiki/Cryptography/Public_Key_Overview) available online which describe the basics of public-key cryptography.
This post will not focus on the basics but rather a specific implementation of using GPG with a [YubiKey](https://www.yubico.com/).
With this approach you'll have your GPG secrets in a portable and secure device which you can then use on any machine.

In short, public-key cryptography is aimed at allowing two parties to securely generate a secret, a secure key, through an insecure communication channel.
In essence, two parties will share some public information, completely in the clear for anyone to see/record, yet they will still arrive at the same secret key!
With this secret key, both parties can then encrypt data and securely pass it between themselves. 

One key assumption with public-key cryptography is that the private portions of this key actually remains secret. 
Due to this, the Yubikey provides an excellent solution.
The Yubikey hardware token provides a secure hardware solution to store OpenPGP keys, and act as a second factor device for many web services. 
With the Yubikey, and GPG, you can securely use your private GPG keys with the knowledge that it is techinically infeasible to remove them from the device.

## Requirements

In order to follow this you'll want the following:

1. A YubiKey 4 or better which supports 4096 bit RSA keys. Ideally buy two of them to have a backup.
2. Two USB drives to create a secure OS (Tails) and backup your GPG keys. This is important because without the backup you will have no way to recover your GPG secret if you lose or damge your Yubikeys.
3. Some time and patience. You'll probably run into problems and will have to debug.

This will basically follow the guide by [drduh](https://github.com/drduh/YubiKey-Guide) with some additional details where I ran into issues.

## Creating your GPG keys securely

One of the main benefits of using a Yubikey is that you can be certain that your private keys are actually secure. 
If you generate all of these "secret" keys on a public or compromised system then none of this stuff really matters. 
For this reason, it makes the most sense to do the following on a secure system, such as [Tails OS](https://tails.boum.org/index.en.html).

Follow the instructions and create a secure Tails OS.
You'll essentially download Tails, create a live USB, then boot to this version and create a really secure version of Tails on your second USB drive. 
It's important that the system you use to create your GPG keys is actually secure or it'll defeat the whole point of your Yubikey if someone can just read your private key directly.
If you're really paranoid you could even use Tails on an airgapped machine.

Once you have Tails setup, boot into it and install the following software

~~~
sudo apt-get update
sudo apt-get install -y \
    curl gnupg2 gnupg-agent \
    cryptsetup scdaemon pcscd \
    yubikey-personalization \
    dirmngr \
    secure-delete \
    hopenpgp-tools
~~~

## Creating new GPG keys

Here we'll create brand new keys. 
If you want you could transfer already created keys onto your Tails distribution.
However, by securely creating brand new keys on Tails you can be more sure that the only copy of your private key will exist securely on your Yubikey and your backup.

First we'll create a temporary directory for GPG

~~~
export GNUPGHOME=$(mktemp -d); echo $GNUPGHOME
~~~

Now you can use the hardended GPG settings from [here](https://github.com/drduh/config/blob/master/gpg.conf) or copy the following in `$GNUPGHOME/gpg.conf`

~~~
personal-cipher-preferences AES256 AES192 AES
personal-digest-preferences SHA512 SHA384 SHA256
personal-compress-preferences ZLIB BZIP2 ZIP Uncompressed
default-preference-list SHA512 SHA384 SHA256 AES256 AES192 AES ZLIB BZIP2 ZIP Uncompressed
cert-digest-algo SHA512
s2k-digest-algo SHA512
s2k-cipher-algo AES256
charset utf-8
fixed-list-mode
no-comments
no-emit-version
keyid-format 0xlong
list-options show-uid-validity
verify-options show-uid-validity
with-fingerprint
require-cross-certification
no-symkey-cache
throw-keyids
use-agent
~~~

We'll start by creating a Master Key. 
This Master key should be kept offline at all times and is only used to certify your other keys, namely encryption, signing, and authentication subkeys that will be stored on the Yubikey and used for all other purposes.
In addition, the Master Key will be used to revoke or create new subkeys.

When creating your key you'll be prompted to enter a password. 
Enter a good password and make sure you write it down and store it securely. 
If you forget you'll have to start over.

### Creating the master key

We'll use GPG to create a master key with `Certify` only authority

~~~
gpg --expert --full-gen-key
~~~

1. Select 8: RSA (set your own capabilities)

2. Select E to toggle off the Encrypt capability, which will leave you with only Sign + Certify.

3. Select S to toggle off the Sign capability, which leaves only Certify

4. Set a 4096 bit key size, if you have some specific need you can chose 2048 bit for older hardware

5. No need to set an expiration date for this key

6. Enter your name, email and a comment to setup the UID.

7. Setup a passphrase.

Once the key is generated you should note the `KEYID`

~~~
export KEYID=0x20D0685093466FC7
~~~

which you'll use later


## Setting up Git to use your GPG keys for SSH access and signing

## Basic GPG usage

## Additional information

* [Operational PGP](https://gist.github.com/grugq/03167bed45e774551155)
* [Yubikey 4 guide](https://blog.liw.fi/posts/2017/05/29/using_a_yubikey_4_for_ensafening_one_s_encryption/)
* [Yubikey guide](https://ttmm.io/tech/yubikey/)
* [Quick Start GPG](https://github.com/bfrg/gpg-guide)
* [Yubikey Guide](https://github.com/drduh/YubiKey-Guide)
